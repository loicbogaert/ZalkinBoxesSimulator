import React from 'react';

const items1 = [  
    {
    name: 'Sunrise Wing',
    imageUrl: 'img/list1/img1.png',
    point: 500,
    id:1,
    number: 1,
    rarity : "common"
},

{
    name: 'Sunrise Body Armour',
    imageUrl: 'img/list1/img2.png',
    point: 250,
    id:2,
    number: 1,
    rarity : "common"
},

{
    name: 'Sunrise Cloak',
    imageUrl: 'img/list1/img3.png',
    point: 250,
    id:3,
    number: 1,
    rarity : "common"

},

{
    name: 'Sunrise Character Effect',
    imageUrl: 'img/list1/img4.png',
    point: 250,
    id:4,
    number: 1,
    rarity : "common"
},

{
    name: 'Sunrise shield',
    imageUrl: 'img/list1/img5.png',
    point: 250,
    id:5,
    number: 1,
    rarity : "common"

},

{
    name: 'Obj2',
    imageUrl: 'img/list1/img6.png',
    point: 500,
    id:6,
    number: 1,
    rarity : "common"
},

{
    name: 'Obj1',
    imageUrl: 'img/list1/img7.png',
    point: 250,
    id:7,
    number: 1,
    rarity : "common"

},

{
    name: 'Obj2',
    imageUrl: 'img/list1/img8.png',
    point: 250,
    id:8,
    number: 1,
    rarity : "common"
},

{
    name: 'Obj1',
    imageUrl: 'img/list1/img9.png',
    point: 500,
    id:9,
    number: 1,
    rarity : "common"

},

{
    name: 'Obj2',
    imageUrl: 'img/list1/img10.png',
    point: 250,
    id:10,
    number: 1,
    rarity : "common"
},

{
    name: 'Obj1',
    imageUrl: 'img/list1/img11.png',
    point: 250,
    id:11,
    number: 1,
    rarity : "common"

},

{
    name: 'Obj2',
    imageUrl: 'img/list1/img12.png',
    point: 500,
    id:12,
    number: 1,
    rarity : "common"
},

{
    name: 'Obj1',
    imageUrl: 'img/list1/img13.png',
    point: 250,
    id:13,
    number: 1,
    rarity : "common"

},

{
    name: 'Obj2',
    imageUrl: 'img/list1/img14.png',
    point: 250,
    id:14,
    number: 1,
    rarity : "common"
},

{
    name: 'Obj1',
    imageUrl: 'img/list1/img15.png',
    point: 500,
    id:15,
    number: 1,
    rarity : "common"

},

{
    name: 'Obj2',
    imageUrl: 'img/list1/img16.png',
    point: 250,
    id:16,
    number: 1,
    rarity : "common"
},

{
    name: 'Obj1',
    imageUrl: 'img/list1/img17.png',
    point: 250,
    id:17,
    number: 1,
    rarity : "common"

},

{
    name: 'Obj2',
    imageUrl: 'img/list1/img18.png',
    point: 500,
    id:18,
    number: 1,
    rarity : "rare"
    
},

{
    name: 'Obj1',
    imageUrl: 'img/list1/img19.png',
    point: 250,
    id:19,
    number: 1,
    rarity : "rare"
}]

const items2 = [
    {
        name: 'Sunrise Wing',
        imageUrl: 'img/list2/imgg1.png',
        point: 500,
        id:20,
        number: 1,
        rarity : "rare"
        
    },

    {
        name: 'Sunrise Body Armour',
        imageUrl: 'img/list2/imgg2.png',
        point: 250,
        id:21,
        number: 1,
        rarity : "rare"
        
    },

    {
        name: 'Sunrise Cloak',
        imageUrl: 'img/list2/imgg3.png',
        point: 250,
        id:22,
        number: 1,
        rarity : "rare"
        

    },

    {
        name: 'Sunrise Character Effect',
        imageUrl: 'img/list2/imgg4.png',
        point: 250,
        id:23,
        number: 1,
        rarity : "rare"
        
    },

    {
        name: 'Sunrise shield',
        imageUrl: 'img/list2/imgg5.png',
        point: 250,
        id:24,
        number: 1,
        rarity : "rare"
        

    },

    {
        name: 'Obj2',
        imageUrl: 'img/list2/imgg6.png',
        point: 500,
        id:25,
        number: 1,
        rarity : "rare"
        
    },

    {
        name: 'Obj1',
        imageUrl: 'img/list2/imgg7.png',
        point: 250,
        id:26,
        number: 1,
        rarity : "rare"
        

    },

    {
        name: 'Obj2',
        imageUrl: 'img/list2/imgg8.png',
        point: 250,
        id:27,
        number: 1,
        rarity : "rare"
        
    },

    {
        name: 'Obj1',
        imageUrl: 'img/list2/imgg9.png',
        point: 500,
        id:28,
        number: 1,
        rarity : "rare"
        

    },

    {
        name: 'Obj2',
        imageUrl: 'img/list2/imgg10.png',
        point: 250,
        id:29,
        number: 1,
        rarity : "rare"
        
    },

    {
        name: 'Obj1',
        imageUrl: 'img/list2/imgg11.png',
        point: 250,
        id:30,
        number: 1,
        rarity : "rare"
        

    },

    {
        name: 'Obj2',
        imageUrl: 'img/list2/imgg12.png',
        point: 500,
        id:31,
        number: 1,
        rarity : "uncommon"
    },

    {
        name: 'Obj1',
        imageUrl: 'img/list2/imgg13.png',
        point: 250,
        id:32,
        number: 1,
        rarity : "uncommon"

    },

    {
        name: 'Obj2',
        imageUrl: 'img/list2/imgg14.png',
        point: 250,
        id:33,
        number: 1,
        rarity : "uncommon"
    },

    {
        name: 'Obj1',
        imageUrl: 'img/list2/imgg15.png',
        point: 500,
        id:34,
        number: 1,
        rarity : "uncommon"

    },

    {
        name: 'Obj2',
        imageUrl: 'img/list2/imgg16.png',
        point: 250,
        id:35,
        number: 1,
        rarity : "uncommon"
    },

    {
        name: 'Obj1',
        imageUrl: 'img/list2/imgg17.png',
        point: 250,
        id:36,
        number: 1,
        rarity : "uncommon"

    },

    {
        name: 'Obj2',
        imageUrl: 'img/list2/imgg18.png',
        point: 500,
        id:37,
        number: 1,
        rarity : "uncommon"
    },
    
    {
        name: 'Obj1',
        imageUrl: 'img/list2/imgg19.png',
        point: 250,
        id:38,
        number: 1,
        rarity : "uncommon"

    },  
]

localStorage.setItem('item1', JSON.stringify(items1))
localStorage.setItem('item2', JSON.stringify(items2))

function refresh() {
    window.location.reload(false);
}

// Array with all items
const allItems = [];

if(localStorage.getItem('item1')) {
    const items1 = JSON.parse(localStorage.getItem('item1'))
    for(let i = 0; i < items1.length; i++) {
        allItems.push(items1[i]);
    }
}

if(localStorage.getItem('item2')) {
    const items2 = JSON.parse(localStorage.getItem('item2'))
    for(let i = 0; i < items2.length; i++) {
        allItems.push(items2[i]);
    }
}




/**Function to get a random number */
function getRandomNumber(min, max) {
    return Math.floor(Math.random() * (max - min +1)) + min;
}

// arrays with the different rarities

var uncommon = allItems.filter(obj => {
    return obj.rarity === "uncommon"
})

var rare = allItems.filter(obj => {
    return obj.rarity === "rare"
})

var common = allItems.filter(obj => {
    return obj.rarity === "common"
})

/**Arrays loot box && array with choices */
const boxesArray = [];

/**Calcs for total points of items owned */
var onlyPointsArray = []


// Box infos component
class BoxRules extends React.Component{
    constructor(props){
        super(props);
        this.state = {
            /**single item opened with box */
           randomItem : "",
           imageUrl : "",
           isActive : false,
           point : 0,
           /** Calcs */
           total : 0,
           numberOfBoxes : 0,
           totalBoxPoints : 0,
           totalWorth : 0,
           leftToPay : 0,
           finalTotal : 0
        }
    }

    // Function on click to trigger random item
     handleClick() {
         /**Choice of rarity and item (random)*/
        let arrayChoice = getRandomNumber(1, 100);
        this.setState({ isActive : this.state.isActive = true})
        if (arrayChoice <= 20) {      /*RARE*/ 
            var item = rare[Math.floor(Math.random()*rare.length)];
            this.setState({ randomItem : this.state.randomItem = item.name });
            this.setState({ imageUrl : this.state.imageUrl = item.imageUrl });
            this.setState({ point : this.state.point = item.point });

            /** Array of item gotten in boxes */
            if (boxesArray.includes(item)) {
                var index = boxesArray.indexOf(item);
                boxesArray[index].number = boxesArray[index].number+=1;
                localStorage.setItem('boxesArray', JSON.stringify(boxesArray))
            }
            else {
                boxesArray.push(item);
                localStorage.setItem('boxesArray', JSON.stringify(boxesArray))
            }
        }

        else if (arrayChoice >= 55) { /*COMMON*/ 
            var item2 = common[Math.floor(Math.random()*common.length)];
            this.setState({ randomItem : this.state.randomItem = item2.name});
            this.setState({ imageUrl : this.state.imageUrl = item2.imageUrl});
            this.setState({ point : this.state.point = item2.point });

            /** Array of item gotten in boxes */
            if (boxesArray.includes(item2)) {
                var index = boxesArray.indexOf(item2);
                boxesArray[index].number = boxesArray[index].number+=1;
                localStorage.setItem('boxesArray', JSON.stringify(boxesArray))
            }
            else {
                boxesArray.push(item2);
                localStorage.setItem('boxesArray', JSON.stringify(boxesArray))
            }
        }

        else {                        /*UNCOMMON*/ 
            var item3 = uncommon[Math.floor(Math.random()*uncommon.length)];
            this.setState({ randomItem : this.state.randomItem = item3.name});
            this.setState({ imageUrl : this.state.imageUrl = item3.imageUrl});
            this.setState({ point : this.state.point = item3.point });

            /** Array of item gotten in boxes */
            if (boxesArray.includes(item3)) {
                var index = boxesArray.indexOf(item3);
                boxesArray[index].number = boxesArray[index].number+=1;
                localStorage.setItem('boxesArray', JSON.stringify(boxesArray))
            }
            else {
                boxesArray.push(item3);
                localStorage.setItem('boxesArray', JSON.stringify(boxesArray))
            }
        }
    }

    resetBox() {
        this.setState({ isActive : this.state.isActive = false})
    }


    handleClick2() {
        /**Array of choices and array of loots */
        var item2 = JSON.parse( localStorage.getItem('boxesArray') );
        var item = JSON.parse( localStorage.getItem('choicesArray') );

        /**Array with values to deduce from total points (not wanted items) */
        var notWantedTotal = [];

        onlyPointsArray.push(this.state.point);
        const total = onlyPointsArray.reduce((a, b)=> a + b, 0);
        this.setState({total : total});

        /**Calcs for number of boxes */
       // const numberOfBoxes = onlyPointsArray.length;
        var numberOfBoxes = 0;
        for (let i = 0; i < boxesArray.length; i++){
            numberOfBoxes += boxesArray[i].number;
       }
        this.setState({numberOfBoxes : numberOfBoxes});

        /**Calcs for total cost of boxes */
        const totalBoxPoints = numberOfBoxes * 30;
        this.setState({totalBoxPoints : totalBoxPoints});

        /**compare the two arrays*/
        function Negates() {
            for(let i = 0; i < item2.length; i++) {
                // if(the item is found in both arrays)
                if(item.find(x => x.item.id === item2[i].id)) {
                    // if choice array < loot array => push it in not wanted
                    var ifPositive = item.find(x => x.item.id === item2[i].id).item.number - item2[i].number;
                    if(ifPositive < 0) {
                        notWantedTotal.push(ifPositive * item2[i].point)
                    }
                }
                // else push it in not wanted anyway
                else {
                    notWantedTotal.push(item2[i].number * -item2[i].point)
                }
            }
            /**final calcs*/
            var myTotal = 0;
            for (let i = 0; i < notWantedTotal.length; i++) {
                 myTotal += notWantedTotal[i];
            }
            return myTotal;
        }

        /**total worth */
       const totalWorth = total - totalBoxPoints + Negates();
       this.setState({totalWorth : totalWorth});

        /**What's left to pay to get all the items you wanted*/
        var choiceListPrice = [];
        for (let i = 0; i < item.length; i++) {
           choiceListPrice.push(item[i].item.point * item[i].item.number)
        }
        var totalChoice = choiceListPrice.reduce((a, b)=> a + b, 0);

        const leftToPay = totalChoice - total - notWantedTotal.reduce((a, b)=> a + b, 0);
        this.setState({leftToPay : leftToPay})

        /**Final total (total he's paying to get all he wants)*/
        const finalTotal = leftToPay + totalBoxPoints;
        this.setState({finalTotal : finalTotal})
    }

    render() {
        return (<Child isActive = {this.state.isActive} point = {this.state.point} randomItem = {this.state.randomItem} imageUrl = {this.state.imageUrl} handleClick={() =>{this.handleClick(); this.handleClick2()}} resetBox={this.resetBox.bind(this)} total = {this.state.total} totalWorth={this.state.totalWorth} numberOfBoxes={this.state.numberOfBoxes} totalBoxPoints = {this.state.totalBoxPoints} leftToPay = {this.state.leftToPay} finalTotal = {this.state.finalTotal}/>);
    }
}

// return dom elements
class Child extends React.Component{
    render () {

        // setting classes and class changes
        let chest = 'chestOpening__chestImg';
        if(this.props.isActive) {
            chest = 'chest hidden'
        }

        let iteminfos = 'chestOpening__info';
        if(this.props.isActive) {
            iteminfos = 'iteminfos'
        }

        let resetButton = 'hidden';
        if(this.props.isActive) {
            resetButton = 'chestOpening__reset'
        }


        if(this.props.isActive === false) {
            iteminfos = 'hidden'
        }

        return(
            <div className="containerCalcPoints">
                <div className="chestOpening">
                    <div className='madiv'>
                        <h2 className="chestOpening__openIt">Click the box to open it !</h2>
                        <img className={chest} src="img/poe box.png" onClick={this.props.handleClick} alt="Poe box to open"/>
                        <div className={iteminfos}>
                        <p className="chestOpening__itemName">{this.props.randomItem}</p>
                        <img className="chestOpening__itemImg" src={this.props.imageUrl} alt={this.props.name}/>
                    </div>
                        <button className={resetButton}  onClick={this.props.resetBox}>Open another box !</button>
                    </div>
                </div>
                <button className="resetAll button buttonReset" onClick={refresh}>Reset</button>
                <div className="classPointsContainer white lists_simulator">
                    <div>
                        <p className="classPointsContainer__txt">Total boxes used : {this.props.numberOfBoxes}</p>
                        <p className="classPointsContainer__txt">Total price of all items you got : {this.props.total} <img src="img/coin.png" className="classPointsContainer__img" alt="Path of exile coin"/></p>
                        <p className="classPointsContainer__txt">Total cost of boxes : {this.props.totalBoxPoints} <img src="img/coin.png" className="classPointsContainer__img" alt="Path of exile coin"/></p>
                    </div>

                    <div>
                        <p className="classPointsContainer__txt">(based on items you want) Gains / loss : {this.props.totalWorth} <img src="img/coin.png" className="classPointsContainer__img" alt="Path of exile coin"/></p>
                        <p className="classPointsContainer__txt">Left to pay to get all the items you wanted : {this.props.leftToPay} <img src="img/coin.png" className="classPointsContainer__img" alt="Path of exile coin"/></p>
                        <p className="classPointsContainer__txt">Total cost to get all the items you wanted : {this.props.finalTotal} <img src="img/coin.png" className="classPointsContainer__img" alt="Path of exile coin"/></p>
                    </div>
                </div> 

                 <div className="lists">
                    {boxesArray.map((lootItem) => (
                        <div className="loots">
                            <img src={lootItem.imageUrl} alt={lootItem.name}/>
                            <p className="loots__img">{lootItem.name}</p>
                            <p className="loots__number">x {lootItem.number}</p>
                        </div>
                    ))}
                 </div>
            </div> 
        ) 
    }
}

export default BoxRules;